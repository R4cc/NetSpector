@page "/autoscans"
@using NCrontab
@inject IUnitOfWork _uow
@inject NavigationManager nav
@inject DialogService DialogService

<PageTitle>NetSpector - Autoscans</PageTitle>

<div class="container" >
    <div class="row" style="margin-bottom: 1.5em; margin-left: 0em">
        <div class="col">
            <h1 style="font-size: 4em">Autoscans</h1>
            <RadzenButton Click=CreateScan Icon="add">New Autoscan</RadzenButton>
        </div>
    </div>
    <div class="row">
        <div class="col">
            @if(_scans is not null && _scans.Count == 0)
            {
                <a>No autoscans setup...</a>
            }
        </div>
    </div>
    <div class="row">
        @if(_scans is null)
        {
            <a>Loading ...</a>
        }
        else
        {
            <div class="container" style="display: flex; flex-wrap: wrap; justify-content: flex-start; gap: 0.2em; row-gap: 2.5em;">
                @foreach(var scan in _scans)
                {
                    <div class="col" style="max-width: 25em; min-width: 25em">
                        <RadzenCard Style="width: 100%">
                            <div class="row" style="margin-bottom: 0.5em;">
                                <div class="col-10">
                                    <h1>@scan.Network.IpNetworkId</h1>
                                </div>
                                <div class="col-2">
                                    <RadzenSwitch Style="margin-left: -2em; vertical-align: middle" @bind-Value="scan.IsActive"/>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <h4>Next Scan: </h4>
                                </div>
                                <div class="col">
                                    <h4 style="font-weight: 400">@(scan.NextExecute.Date == DateTime.Today ? "Today " + scan.NextExecute.ToString("H:mm") : scan.NextExecute.ToString("g"))</h4>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <h4>Last Scanned: </h4>
                                </div>
                                <div class="col">
                                    <h4 style="font-weight: 400">@(scan.LastExecuted is null ? "N/A" : (scan.LastExecuted.Value.Date == System.DateTime.Today ? "Today " + System.Convert.ToDateTime(scan.LastExecuted).ToString("H:mm") : (Convert.ToDateTime(scan.LastExecuted)).ToString("g")))</h4>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <h4>Status: </h4>
                                </div>
                                <div class="col">
                                    <h4 style="font-weight: 400"><RadzenBadge BadgeStyle="@(scan.IsActive ? BadgeStyle.Primary : BadgeStyle.Danger)" Text="@(scan.IsActive ? "ACTIVE" : "INACTIVE")"/></h4>
                                </div>
                            </div>
                            <hr/>
                            <div class="row">
                                <div class="col-10">
                                    <RadzenButton Style="width: 100%" Click="(() => LoadScan(scan.ScanId))">Details</RadzenButton>
                                </div>                
                                <div class="col-2">
                                    <RadzenButton Click="(() => RemoveScan(scan))" ButtonStyle="ButtonStyle.Danger" Style="margin-left: -1em" Icon="delete_forever" />
                                </div>
                            </div>
                        </RadzenCard>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code{
    private List<Scan>? _scans;

    protected override async Task OnInitializedAsync()
    {
        await LoadScans();
    }

    private async Task LoadScans()
    {
        _scans = await _uow.IScanRepository.GetAll();
    }    

    private async Task LoadScan(int scanId)
    {
        nav.NavigateTo($"/autoscan/{scanId}");
    }
    
    private async Task CreateScan()
    {
        nav.NavigateTo($@"/autoscan/create");
    }        
    
    private async Task RemoveScan(Scan scan)
    {
        bool? confirmDelete = (bool)await DialogService.Confirm("Are you sure you want to delete the scan?", $"Delete {scan.Network.Name} Scan?", new ConfirmOptions() { OkButtonText = "Confirm", CancelButtonText = "Cancel" });

        if (confirmDelete is null)
            return;

        if(!(bool)confirmDelete)
            return;

        await _uow.IScanRepository.Remove(scan);
        await _uow.SaveChangesAsync();
        await LoadScans();
    }    
}