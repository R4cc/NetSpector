@page "/network/{networkid:int}"
@using System.Drawing

@inject IUnitOfWork _uow
@inject PingService PingService
@inject NavigationManager Nav


@if (_devices is null)
{
    <a>Loading...</a>    
}
else
{
<div class="container">
    <div class="row">
    
        <h2>Network Devices</h2>
        <h4>@_devices.Count Devices</h4>
        <RadzenButton BusyText="Scanning ..." IsBusy=@_processing Click=@ScanNetwork Text="Scan Network" Style="max-width: 10em; margin-bottom: 1em; margin-left: 1em"/>
        </div>
        <div class="row">
        <div class="col">
            <table class="table">
                <thead>
                <tr>
                    <td>Name</td>
                    <td>IP Address</td>
                    <td>Vendor</td>
                    <td>Status</td>
                    <td>Last Seen</td>
                    <td>Controls</td>
                </tr>
                </thead>
                <tbody>
                @foreach (var device in _devices.OrderBy(d => d.Int32IpAddress))
                {
                    <tr>
                        <td>@(String.IsNullOrEmpty(device.Name) ? (String.IsNullOrEmpty(device.Hostname) ? "N/A" : device.Hostname) : device.Name)</td>
                        <td>@device.IpAddress</td>
                        <td>@(device.Manufacturer != null ? device.Manufacturer.Name : "N/A")</td>
                        <td><RadzenBadge BadgeStyle="@(device.IsOnline ? BadgeStyle.Success : BadgeStyle.Danger)" Text="@(device.IsOnline ? "ONLINE" : "OFFLINE")"/></td>
                        <td>@device.LastSeen.ToString("g")</td>
                        <td>
                            <RadzenButton Click=@(() => PingDevice(device.DeviceId)) Icon="contactless"/>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    </div>
</div>
}

@code {
    [Parameter]
    public int networkId { get; set; }
    private bool _processing;
    private List<Device> _devices;

    protected override async Task OnInitializedAsync()
    {
        await LoadDevices();
    }

    private async Task LoadDevices()
    {
        _devices = (await _uow.IDeviceRepository.GetDevicesFromNetworkId(networkId));
    }    
    
    private async Task EditDevice(int deviceId)
    {
       Nav.NavigateTo($"/device/edit/{deviceId}");
    }        
    
    private async Task PingDevice(int deviceId)
    {
       Nav.NavigateTo($"/device/ping/{deviceId}");
    }    
    
    private async Task ScanNetwork()
    {
        _processing = true;

        // this task delay is needed for the processing status to work.. dont ask me why
        await Task.Delay(1);
        
        var network = await _uow.INetworkRepository.GetNetworkFromId(networkId);
        await _uow.INetworkRepository.Update(await PingService.ScanNetwork(network));
        await _uow.SaveChangesAsync();
        
        await LoadDevices();
        _processing = false;
    }
    
}